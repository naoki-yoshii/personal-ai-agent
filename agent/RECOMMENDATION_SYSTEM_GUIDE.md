# おすすめ系クエリの汎用ルール

## 変更内容

### 修正したファイル

**`agent/src/agentCore.ts` (266-323行目)**

システムプロンプトに「おすすめ系の質問に関する共通ルール」を追加しました。

---

## 追加したルールの概要

### 目的

ユーザーが「おすすめ」を求める質問をしたときに、Notionのデータベースに入っている項目をそのまま列挙するのではなく、以下のような振る舞いをするようにしました：

1. **Notionのデータを「嗜好履歴」として解釈**
2. **嗜好プロファイルを作成**
3. **Web検索から新しい候補を探す**
4. **Notionにない候補を優先**

---

## システムプロンプトに追加した内容

### 1. おすすめ系クエリの検知

以下のような質問を「おすすめ系クエリ」として検知します：

- 「おすすめの〇〇を教えて」
- 「〇〇でどこがいい？」
- 「〇〇なら何がいい？」

**対象ジャンル:**
- 映画、アニメ、漫画、ゲーム
- 旅行先、観光スポット
- 本、小説、ライトノベル
- お酒、料理
- その他すべてのジャンル

---

### 2. Notionデータの正しい解釈

**Before（問題のある挙動）:**
```
ユーザー: 「映画のおすすめを教えて」
↓
Notionから映画DBを取得
↓
映画DBに入っている作品をそのまま列挙
→ 「インターステラー、インセプション、マトリックス...がおすすめです」
```

**After（改善後の挙動）:**
```
ユーザー: 「映画のおすすめを教えて」
↓
Notionから映画DBを取得
↓
「このユーザーはSF作品、複雑なストーリー、クリストファー・ノーラン作品を好む」
と嗜好プロファイルを作成
↓
Web検索で似た傾向の新作映画を探す
↓
Notionにない映画を優先しておすすめ
```

---

### 3. 嗜好プロファイルの作成

Notionのデータから以下を読み取ります：

- **評価が高いものの共通点**
  - 例: ジャンル、監督、俳優、テーマ
- **よく登録されているカテゴリ**
  - 例: SF、ファンタジー、コメディ
- **作品傾向**
  - 例: シリアス、アクション重視、感動系

---

### 4. 外部から新しい候補を探す

Web検索などの外部情報から、嗜好プロファイルに合いそうな候補を探します。

**映画・アニメ・漫画・ゲーム:**
- 一般的な作品情報サイト
- ランキングサイト
- レビューサイト

**旅行:**
- 観光情報サイト
- ブログ
- まとめ記事

---

### 5. Notionにない候補を優先

- **原則:** Notionに既に登録されている作品/場所は除外
- **例外:** どうしても強くすすめたい場合は注釈を添える
  - 「これは既にNotionに登録されている（過去に体験済み）かもしれませんが、特におすすめです」

---

### 6. 最終的な回答の形式

以下の情報をセットで提示：

1. **おすすめ候補の名前**
   - 作品名/スポット名など

2. **ユーザーの嗜好との関連性**
   - Notionのどんな履歴からそう判断したか

3. **簡単な説明**
   - あらすじ・特徴・雰囲気・どんな人に向いているか

4. **件数**
   - 2〜5件程度に絞って提示

---

### 7. 禁止事項

**❌ やってはいけないこと:**
- Notionのデータベースに入っている項目を、そのまま「おすすめリスト」として列挙する
- 「Notionにこれが入っていました」で終わる

**✅ やるべきこと:**
- 「Notionの履歴や好みを読み取る → 外部の情報から新しい候補を探す」という流れで回答

---

## 動作例

### ケース1: 「映画のおすすめを教えて」

**Notionのデータ:**
- インターステラー（評価: 5/5、ジャンル: SF）
- インセプション（評価: 5/5、ジャンル: SF）
- マトリックス（評価: 4/5、ジャンル: SF/アクション）

**嗜好プロファイル:**
- SF作品を好む
- 複雑なストーリーを好む
- クリストファー・ノーラン作品を好む

**おすすめ候補（Web検索から）:**
1. **テネット**
   - ノーラン監督の最新SF作品
   - 時間の逆行を描く複雑なストーリー
2. **メッセージ**
   - SF言語学を扱う知的な作品
   - 時間のループを描く
3. **DUNE/デューン 砂の惑星**
   - 壮大なSF叙事詩
   - 複雑な世界観

---

### ケース2: 「アニメのおすすめある？」

**Notionのデータ:**
- 進撃の巨人（評価: 5/5、ジャンル: ダークファンタジー）
- 鋼の錬金術師（評価: 5/5、ジャンル: ダークファンタジー）
- PSYCHO-PASS（評価: 4/5、ジャンル: SF/サスペンス）

**嗜好プロファイル:**
- ダークファンタジー・SF作品を好む
- シリアスなストーリーを好む
- 考えさせられる作品を好む

**おすすめ候補（Web検索から）:**
1. **呪術廻戦**
   - ダークファンタジー
   - シリアスな戦闘描写
2. **86-エイティシックス-**
   - SF/戦争もの
   - 社会問題を描く
3. **ヴィンランド・サガ**
   - 歴史ダークファンタジー
   - 人間ドラマ重視

---

### ケース3: 「京都旅行でおすすめスポットは？」

**Notionのデータ:**
- 金閣寺（評価: 5/5、カテゴリ: 寺社仏閣）
- 清水寺（評価: 4/5、カテゴリ: 寺社仏閣）
- 伏見稲荷大社（評価: 5/5、カテゴリ: 神社）

**嗜好プロファイル:**
- 寺社仏閣を好む
- 歴史的建造物を好む
- 京都の定番スポットを好む

**おすすめ候補（Web検索から）:**
1. **銀閣寺（慈照寺）**
   - 金閣寺と対をなす銀閣
   - 侘び寂びの美しさ
2. **龍安寺**
   - 石庭が有名
   - 禅の世界観
3. **貴船神社**
   - 山間の神秘的な神社
   - 川床料理も楽しめる

---

## 既存機能への影響

### 保証（変更なし）

- ✅ おすすめ系以外の質問の動作は変更なし
- ✅ レスポンス形式は変更なし
- ✅ Notion/Web検索のロジックは変更なし
- ✅ エラーハンドリングは変更なし

### 改善

- ➕ おすすめ系クエリで、Notionのデータを嗜好情報として活用
- ➕ 新しい候補を外部から探す
- ➕ Notionにない候補を優先
- ➕ より賢いおすすめ機能

---

## テストコマンド

### テスト1: 映画のおすすめ

```bash
npm run dev -- "映画のおすすめを教えて"
```

**期待される挙動:**
1. Notionの映画DBから嗜好を読み取る
2. Web検索で新しい映画情報を探す
3. Notionにない映画を優先しておすすめ

---

### テスト2: アニメのおすすめ

```bash
npm run dev -- "アニメのおすすめある？"
```

**期待される挙動:**
1. NotionのアニメDBから嗜好を読み取る
2. Web検索で新作アニメ情報を探す
3. Notionにないアニメを優先しておすすめ

---

### テスト3: 旅行先のおすすめ

```bash
npm run dev -- "京都旅行でおすすめスポットは？"
```

**期待される挙動:**
1. Notionの旅行DBから好みのスポットタイプを読み取る
2. Web検索で京都の観光情報を探す
3. Notionにないスポットを優先しておすすめ

---

## まとめ

この変更により、エージェントは以下のような振る舞いをするようになりました：

1. **おすすめ系クエリを検知** → 汎用ルールを適用
2. **Notionのデータを嗜好情報として活用** → そのまま列挙しない
3. **嗜好プロファイルを作成** → ユーザーの好みを理解
4. **外部から新しい候補を探す** → Web検索を活用
5. **Notionにない候補を優先** → 新しい体験を提案

これにより、より賢く、パーソナライズされたおすすめができるようになりました。
